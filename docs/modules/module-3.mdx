---
publish: false
---

# Module 3: Express.js Core (Day 3)

คอร์ส Zero to Deploy วันที่สามให้ผู้เรียนสร้าง REST API ด้วย Express แบบมั่นใจภายใน 1 วัน (ทฤษฎี 2 ชม. + โค้ดตาม 1 ชม. + Workshop/Test 1 ชม.) จบคลาสทุกคนต้องต่อ Thunder Client/Postman ได้จริงและอธิบาย middleware ได้เป็น

## Module 3.1 — เริ่มต้นกับ Express

### 1. express() คืออะไร

- Express คือเฟรมเวิร์กที่ครอบ Node.js HTTP module ให้โค้ดกระชับพร้อมระบบ routing/middleware เป็นเหมือน “โรงงาน” ที่รับออเดอร์ (request) แล้วส่งผ่านสายพาน (middleware) ไปยัง station (route handler) ก่อนแพ็กสินค้า (response) ส่งกลับ

```js
const express = require('express');
const app = express();

app.get('/', (req, res) => res.send('Hello Express'));

app.listen(3000, () => {
  console.log('Server ready on http://localhost:3000');
});
```

- `express()` คืน instance `app` ที่ใช้จัดการทุกอย่าง ทั้ง middleware (`app.use`) และ route (`app.get/post/...`)

### 2. โครงสร้างโปรเจกต์สำหรับมือใหม่

```
my-express-app/
├─ package.json
├─ src/
│  ├─ app.js              # รวม middleware + routes
│  ├─ server.js           # start server
│  ├─ routes/
│  │   └─ movieRoutes.js  # ระบุ path/method
│  └─ controllers/
│      └─ movieController.js
└─ middleware/
   └─ logger.js
```

- สายงาน: `server.js` เรียก `app.js` → โหลด built-in middleware (`express.json`) + custom (`logger`) → เดินเข้า router → controller ตอบกลับ
- เปรียบเทียบเป็น “แผนที่ห้าง”: ชั้นล่าง (`server.js`) เปิดประตู, ชั้นกลาง (`routes`) ชี้ทาง, ชั้นบน (`controllers`) ให้บริการ

### 3. Routing พื้นฐาน (GET/POST/PUT/DELETE)

- Route = HTTP Method + Path + Handler `(req, res)`
- ใช้ `express.Router()` ช่วยแยกไฟล์ให้โค้ดโตแล้วยังอ่านง่าย

```js
const express = require('express');
const router = express.Router();
const movies = [];

router.get('/movies', (_req, res) => res.json(movies));

router.post('/movies', (req, res) => {
  const movie = { id: Date.now().toString(), ...req.body };
  movies.push(movie);
  res.status(201).json(movie);
});

router.put('/movies/:id', (req, res) => {
  const idx = movies.findIndex(m => m.id === req.params.id);
  if (idx === -1) return res.status(404).send('Not found');
  movies[idx] = { ...movies[idx], ...req.body };
  res.json(movies[idx]);
});

router.delete('/movies/:id', (req, res) => {
  const before = movies.length;
  const filtered = movies.filter(m => m.id !== req.params.id);
  if (filtered.length === before) return res.status(404).send('Not found');
  movies.length = 0;
  movies.push(...filtered);
  res.status(204).send();
});

module.exports = router;
```

- เน้นให้ผู้เรียน map Method ↔ CRUD: GET=อ่าน, POST=สร้าง, PUT=อัปเดต, DELETE=ลบ

### 4. Middleware คืออะไร

- Middleware = ฟังก์ชันที่วิ่งก่อนถึง route handler มี signature `(req, res, next)`
- ประเภทหลัก:
  - Application-level: ผูกกับ `app.use()` ครอบทุก request (เช่น body parser, logger)
  - Router-level: ผูกกับ `router.use()` สำหรับ path/กลุ่มเฉพาะ
  - Built-in: Express เตรียมให้ เช่น `express.json()`, `express.static()`
  - Third-party: npm packages เช่น `morgan`, `cors`

```js
const logger = (req, _res, next) => {
  console.log(`${req.method} ${req.path}`);
  next(); // จำเป็นต้องเรียก ไม่งั้น request จะค้าง
};

app.use(express.json()); // built-in
app.use(logger);         // application-level

router.use('/movies', (req, res, next) => {
  // router-level example
  if (!req.headers['x-api-key']) return res.status(401).send('Missing key');
  next();
});
```

- ภาพจำ: middleware คือด่านตรวจแต่ละชั้น ถ้าไม่เรียก `next()` ลูกค้าจะติดอยู่ที่ด่านนั้น

### 5. การใช้ req / res ให้เห็นภาพ

| ตัวแปร | ใช้เมื่อ | ตัวอย่าง |
| --- | --- | --- |
| `req.params` | path variables | `/movies/:id` → `req.params.id` |
| `req.query` | query string | `/movies?limit=10` → `req.query.limit` |
| `req.body` | ข้อมูลที่ client ส่งมาใน body | ใช้คู่กับ `express.json()` |
| `res.send` | ส่ง string/HTML | `res.send('OK')` |
| `res.json` | ส่ง JSON พร้อม header | `res.json({ data })` |
| `res.status` | ตั้ง HTTP status ก่อนส่ง | `res.status(404).send('Not found')` |

```js
router.get('/movies/:id', (req, res) => {
  const { id } = req.params;
  const verbose = req.query.verbose === 'true';
  const movie = movies.find(m => m.id === id);

  if (!movie) return res.status(404).json({ message: 'Not found' });
  const payload = verbose ? movie : { id: movie.id, title: movie.title };
  res.json(payload);
});

router.post('/movies', (req, res) => {
  const { title, year } = req.body;
  if (!title) return res.status(400).json({ message: 'title required' });
  // ...
});
```

## Workshop — สร้าง REST API /movies

> ใช้เวลา ~1 ชม. ให้ผู้เรียนจับของจริง ไล่ตั้งโปรเจกต์ → middleware → routes → thunder client

### ขั้นตอน

1. **ตั้งโปรเจกต์**
   ```bash
   npm init -y
   npm install express
   ```

2. **ไฟล์ `src/app.js`**
   ```js
   const express = require('express');
   const movieRoutes = require('./routes/movieRoutes');
   const logger = require('../middleware/logger');

   const app = express();

   app.use(express.json()); // built-in body parser
   app.use(logger);         // custom logger
   app.use('/api', movieRoutes);

   module.exports = app;
   ```

3. **ไฟล์ `src/server.js`**
   ```js
   const app = require('./app');
   const PORT = process.env.PORT || 3000;

   app.listen(PORT, () => console.log(`API ready on http://localhost:${PORT}`));
   ```

4. **ไฟล์ `middleware/logger.js`**
   ```js
   const logger = (req, _res, next) => {
     console.log(`[${new Date().toISOString()}] ${req.method} ${req.path}`);
     next();
   };

   module.exports = logger;
   ```

5. **ไฟล์ `src/controllers/movieController.js`**
   ```js
   let movies = [
     { id: '1', title: 'Interstellar', year: 2014 },
     { id: '2', title: 'Everything Everywhere All at Once', year: 2022 }
   ];

   exports.getMovies = (_req, res) => res.json(movies);

   exports.getMovie = (req, res) => {
     const movie = movies.find(m => m.id === req.params.id);
     if (!movie) return res.status(404).json({ message: 'Not found' });
     res.json(movie);
   };

   exports.createMovie = (req, res) => {
     const { title, year } = req.body;
     if (!title) return res.status(400).json({ message: 'title required' });
     const movie = { id: Date.now().toString(), title, year };
     movies.push(movie);
     res.status(201).json(movie);
   };

   exports.updateMovie = (req, res) => {
     const idx = movies.findIndex(m => m.id === req.params.id);
     if (idx === -1) return res.status(404).json({ message: 'Not found' });
     movies[idx] = { ...movies[idx], ...req.body };
     res.json(movies[idx]);
   };

   exports.deleteMovie = (req, res) => {
     const before = movies.length;
     movies = movies.filter(m => m.id !== req.params.id);
     if (movies.length === before) return res.status(404).json({ message: 'Not found' });
     res.status(204).send();
   };
   ```

6. **ไฟล์ `src/routes/movieRoutes.js`**
   ```js
   const express = require('express');
   const controller = require('../controllers/movieController');

   const router = express.Router();

   router
     .route('/movies')
     .get(controller.getMovies)
     .post(controller.createMovie);

   router
     .route('/movies/:id')
     .get(controller.getMovie)
     .put(controller.updateMovie)
     .delete(controller.deleteMovie);

   module.exports = router;
   ```

7. **ทดสอบด้วย Thunder Client/Postman**
   - ตั้ง Collection “Movies API”
   - รัน `node src/server.js`
   - สร้าง request GET/POST/PUT/DELETE แล้วสลับ body/params ให้ครบ
   - ดู console ว่ามี log `[timestamp] METHOD /api/movies`
   - อธิบายการอ่าน HTTP status, body, และการส่ง header เพิ่ม

## บทสรุปท้ายบท

- express() คือจุดเริ่มเซิร์ฟเวอร์ที่จัดการทั้งหมดผ่าน routing + middleware
- โครงสร้างไฟล์ชัดเจน (`src/app.js`, `routes/`, `controllers/`, `middleware/`) ทำให้โตต่อได้ง่าย
- ผู้เรียนรู้การจับ req/res, แยก method CRUD และทดสอบ API ด้วยเครื่องมือจริง
- Workshop ทำให้ทุกคนมีโปรเจกต์ `/movies` ที่ใช้ logger และ controller แยกไฟล์เรียบร้อย

## Homework

1. เพิ่ม validation ใน `updateMovie` ให้ปฏิเสธ `year` ที่น้อยกว่า 1900 หรือไม่ใช่ตัวเลข พร้อมตอบ 400 + ข้อความอธิบาย
2. เขียน middleware `delay` ที่หน่วง response 1 วินาทีและใช้เฉพาะเส้นทาง `/api/movies` เพื่อดูลำดับการทำงานกับ logger (ใช้ `setTimeout` แล้ว `next()`)
